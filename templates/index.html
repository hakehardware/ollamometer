{% extends "base.html" %}

{% block title %}Ollamometer - Home{% endblock %}

{% block content %}
<div class="benchmark-setup">
    <div class="section">
        <h2>Select Models to Test</h2>
        <div id="models-loading" class="loading">Loading models...</div>
        <div id="models-container" style="display: none;">
            <!-- Add Model Button and Dropdown -->
            <div class="add-model-section">
                <button id="add-model-btn" onclick="toggleModelDropdown()" class="btn-secondary">+ Add Model</button>
                <select id="available-models-select" style="display: none; width: 100%; margin-top: 10px; padding: 8px; font-family: 'Courier New', monospace; font-size: 0.95rem; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 4px;">
                    <option value="">-- Select a model --</option>
                </select>
            </div>

            <!-- Selected Models List -->
            <div id="selected-models-list" style="margin-top: 15px;">
                <!-- Selected models will be added here as chips -->
            </div>
        </div>
        <div id="ollama-error" class="error" style="display: none;">
            WARNING: Cannot connect to Ollama. Make sure Ollama is running with <code>ollama serve</code>
        </div>
    </div>

    <div class="section">
        <h2>Select Benchmark Prompts</h2>
        <p class="description">Different prompts test different hardware characteristics</p>
        <div class="prompt-list">
            {% for prompt in prompts %}
            <div class="prompt-item">
                <input type="checkbox"
                       id="prompt-{{ prompt.id }}"
                       value="{{ prompt.id }}"
                       checked>
                <label for="prompt-{{ prompt.id }}">
                    <span class="prompt-icon">{{ prompt.icon }}</span>
                    <span class="prompt-name">{{ prompt.name }}</span>
                    <span class="prompt-desc">{{ prompt.description }}</span>
                </label>
            </div>
            {% endfor %}
        </div>
        <div class="prompt-controls">
            <button onclick="selectAllPrompts()" class="btn-secondary">Select All</button>
            <button onclick="deselectAllPrompts()" class="btn-secondary">Deselect All</button>
        </div>
    </div>

    <div class="section">
        <h2>Configuration</h2>
        <div class="config-row">
            <label for="runs-per-test">Runs per model/prompt:</label>
            <select id="runs-per-test">
                {% for runs in runs_options %}
                <option value="{{ runs }}" {% if runs == default_runs %}selected{% endif %}>{{ runs }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="total-tests">
            <strong>Total tests:</strong> <span id="total-tests">0</span>
        </div>
    </div>

    <div class="section">
        <button id="start-btn" onclick="startBenchmark()" class="btn-primary" disabled>
            Start Benchmark
        </button>
        <p id="start-warning" class="warning" style="display: none;"></p>
    </div>
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2 id="modal-title">Downloading Models</h2>
        <div class="progress-info">
            <p id="modal-status" class="status-text">Preparing...</p>
            <div class="progress-bar">
                <div id="modal-progress-fill" class="progress-fill" style="width: 0%;"></div>
            </div>
            <p id="modal-details" class="details-text"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
<script>
// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadModels();
    updateTotalTests();

    // Add change listeners
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateTotalTests);
    });
    document.getElementById('runs-per-test').addEventListener('change', updateTotalTests);
});

function toggleModelDropdown() {
    const dropdown = document.getElementById('available-models-select');
    if (dropdown.style.display === 'none') {
        dropdown.style.display = 'block';
        // Add change listener to add selected model
        dropdown.onchange = function() {
            if (this.value) {
                addSelectedModel(this.value);
                this.value = ''; // Reset selection
            }
        };
    } else {
        dropdown.style.display = 'none';
    }
}

function addSelectedModel(modelName) {
    // Add to selected models array
    selectedModelsData.push(modelName);

    // Remove from available dropdown
    const dropdown = document.getElementById('available-models-select');
    for (let i = 0; i < dropdown.options.length; i++) {
        if (dropdown.options[i].value === modelName) {
            dropdown.remove(i);
            break;
        }
    }

    // Hide dropdown if empty
    if (dropdown.options.length === 0) {
        dropdown.style.display = 'none';
    }

    // Render selected models
    renderSelectedModels();
    updateTotalTests();
}

function removeSelectedModel(modelName) {
    // Remove from selected models array
    selectedModelsData = selectedModelsData.filter(m => m !== modelName);

    // Add back to available dropdown
    const modelInfo = allModels.find(m => m.name === modelName);
    if (modelInfo) {
        const dropdown = document.getElementById('available-models-select');
        const option = document.createElement('option');
        option.value = modelInfo.name;
        const badge = modelInfo.downloaded ? '[Ready]' : '[Need Pull]';
        option.textContent = `${modelInfo.name} ${badge}`;
        option.dataset.downloaded = modelInfo.downloaded;
        dropdown.appendChild(option);

        // Sort options alphabetically (skip first placeholder option)
        const placeholder = dropdown.options[0];
        const sortedOptions = Array.from(dropdown.options)
            .slice(1) // Skip placeholder
            .sort((a, b) => a.value.localeCompare(b.value));

        dropdown.innerHTML = '';
        dropdown.appendChild(placeholder);
        sortedOptions.forEach(option => dropdown.appendChild(option));
    }

    // Render selected models
    renderSelectedModels();
    updateTotalTests();
}

function renderSelectedModels() {
    const container = document.getElementById('selected-models-list');
    container.innerHTML = '';

    if (selectedModelsData.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No models selected. Click "Add Model" to select models for testing.</p>';
        return;
    }

    selectedModelsData.forEach(modelName => {
        const modelInfo = allModels.find(m => m.name === modelName);
        if (modelInfo) {
            const chip = document.createElement('div');
            chip.className = 'model-chip';
            const badge = modelInfo.downloaded ? '[Ready]' : '[Need Pull]';
            chip.innerHTML = `
                <span class="model-chip-name">${modelInfo.name} ${badge}</span>
                <button class="model-chip-remove" onclick="removeSelectedModel('${modelInfo.name}')" title="Remove model">Ã—</button>
            `;
            container.appendChild(chip);
        }
    });
}

function selectAllPrompts() {
    document.querySelectorAll('.prompt-item input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
    });
    updateTotalTests();
}

function deselectAllPrompts() {
    document.querySelectorAll('.prompt-item input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    updateTotalTests();
}

function updateTotalTests() {
    const models = selectedModelsData.length;
    const prompts = document.querySelectorAll('.prompt-item input[type="checkbox"]:checked').length;
    const runs = parseInt(document.getElementById('runs-per-test').value);

    const total = models * prompts * runs;
    document.getElementById('total-tests').textContent = total;

    // Enable/disable start button
    const startBtn = document.getElementById('start-btn');
    const warning = document.getElementById('start-warning');

    if (models === 0 || prompts === 0) {
        startBtn.disabled = true;
        warning.style.display = 'block';
        warning.textContent = 'Please select at least one model and one prompt';
    } else {
        startBtn.disabled = false;
        warning.style.display = 'none';
    }
}
</script>
{% endblock %}
